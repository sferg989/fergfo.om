---
import type { GroupedOption } from '../utils/optionsUtils';
import { getStrikeClass, getPremiumClass, calculateAnnualizedPremium } from '../utils/optionsUtils';

interface Props {
  group: GroupedOption;
  currentPrice: number;
}

const { group, currentPrice } = Astro.props;
---

<div class="expiry-group">
  <button class="expiry-header">
    <span class="expiry-date">{group.expiryDate}</span>
    <span class="days-to-expiry">{group.daysToExpiry} days</span>
    <span class="contract-count">{group.options.length} contracts</span>
  </button>
  <div class="options-details hidden">
    <table class="options-table">
      <thead>
        <tr>
          <th>Strike</th>
          <th>Last</th>
          <th>Bid</th>
          <th>Ask</th>
          <th>Volume</th>
          <th>Open Int.</th>
          <th>IV%</th>
          <th>Ann. Prem%</th>
        </tr>
      </thead>
      <tbody>
        {group.options.map((option) => (
          <tr class={getPremiumClass(option, currentPrice)}>
            <td class={getStrikeClass(option.strike, currentPrice)}>
              ${option.strike.toFixed(2)}
              {calculateAnnualizedPremium(option) >= 15 && 'ðŸ”¥'}
              {calculateAnnualizedPremium(option) >= 8 && calculateAnnualizedPremium(option) < 15 && 'ðŸ‘'}
            </td>
            <td>${option.lastPrice.toFixed(2)}</td>
            <td>${option.bid.toFixed(2)}</td>
            <td>${option.ask.toFixed(2)}</td>
            <td>{option.volume}</td>
            <td>{option.openInterest}</td>
            <td>{(option.impliedVolatility * 100).toFixed(1)}%</td>
            <td>{calculateAnnualizedPremium(option).toFixed(1)}%</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>

<style>
  .expiry-group {
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .expiry-header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8fafc;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  .expiry-header:hover {
    background: #f1f5f9;
  }

  .days-to-expiry, .contract-count {
    color: #6b7280;
    font-size: 0.875rem;
  }

  .options-details {
    background: white;
    overflow-x: auto;
  }

  .options-details.hidden {
    display: none;
  }

  .options-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border: 1px solid #e2e8f0;
    font-size: 0.875rem;
  }

  th, td {
    padding: 0.5rem;
    text-align: right;
    border-bottom: 1px solid #e2e8f0;
    white-space: nowrap;
  }

  th:first-child, td:first-child {
    text-align: left;
  }

  th {
    background: #f7fafc;
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tr:hover {
    background: #f8fafc;
  }

  tr:nth-child(even) {
    background: #fafafa;
  }

  .in-the-money {
    color: #2563eb;
    font-weight: 600;
  }

  .out-of-the-money {
    color: #dc2626;
    font-weight: 600;
  }

  .premium-high {
    background-color: rgba(34, 197, 94, 0.2) !important;
  }

  .premium-high:hover {
    background-color: rgba(34, 197, 94, 0.3) !important;
  }

  .premium-medium {
    background-color: rgba(245, 158, 11, 0.2) !important;
  }

  .premium-medium:hover {
    background-color: rgba(245, 158, 11, 0.3) !important;
  }

  .premium-low {
    background-color: rgba(239, 68, 68, 0.2) !important;
  }

  .premium-low:hover {
    background-color: rgba(239, 68, 68, 0.3) !important;
  }

  tr:nth-child(even).premium-high,
  tr:nth-child(even).premium-medium,
  tr:nth-child(even).premium-low {
    background-color: inherit;
  }

  td:first-child {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
</style>
